#!/bin/sh

echo "Running start up script..."

echo "$(git rev-parse --abbrev-ref HEAD)"
if [[ $(git rev-parse --abbrev-ref HEAD) != "master" ]]; then
  echo "Updating Documents"
  /usr/src/app/bin/docapi
  git add -f /usr/src/app/public/apidocs/*
  git commit -m 'doc update'
fi

echo "Checking installed gems..."
/usr/src/app/bin/bundle check || /usr/src/app/bin/bundle install


echo "Checking DB migrations..."
/usr/src/app/bin/rake db:setup
/usr/src/app/bin/rails db:migrate # 2>/dev/null || /usr/src/app/bin/rake db:setup
/usr/src/app/bin/rake db:seed

if [ "$RUN_TESTS" == "true" ]; then
  echo "Running tests"
  /usr/src/app/bin/rails db:test:prepare
  /usr/src/app/bin/rails spec
else
  if [ -f '/usr/src/app/tmp/pids/server.pid' ]; then
    echo "Found existing Puma server process id file, deleting..."
    rm /usr/src/app/tmp/pids/server.pid
  fi
  echo "Starting server."
  /usr/src/app/bin/rails s
fi
